<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Agente de Carreira</title>

    <!-- Fonte -->
    <link
      href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        margin: 0;
        font-family: "Atkinson Hyperlegible", sans-serif;
        background: #f0f4ff;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .header {
        background: #2c70d3;
        color: white;
        padding: 14px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 20px;
        font-weight: bold;
      }

      #backButton {
        background: white;
        color: #2c70d3;
        padding: 8px 16px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 700;
        border: 2px solid white;
      }

      .chat-wrap {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 20px;
        overflow-y: auto;
        gap: 12px;
      }

      .agent-bubble {
        background: #fff;
        padding: 12px 16px;
        border-radius: 12px;
        max-width: 70%;
        color: #1b2b42;
        box-shadow: 0px 2px 8px #00000018;
      }

      .user-bubble {
        background: #2c70d3;
        color: white;
        padding: 12px 16px;
        border-radius: 12px;
        max-width: 70%;
        align-self: flex-end;
        box-shadow: 0px 2px 8px #00000018;
      }

      .input-area {
        display: flex;
        gap: 10px;
        padding: 16px;
        background: #fff;
        border-top: 2px solid #e2e8f0;
      }

      #chatInput {
        flex: 1;
        padding: 12px 14px;
        border-radius: 10px;
        border: 1px solid #cbd5e1;
        outline: none;
        font-size: 16px;
      }

      #sendButton {
        background: #2c70d3;
        color: white;
        padding: 10px 18px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        font-weight: 700;
      }

      #restartButton {
        margin-left: 20px;
        margin-top: 8px;
        background: #edf2ff;
        border: 1px solid #b0c4ff;
        padding: 6px 14px;
        border-radius: 8px;
        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <div class="header">
      Agente Vocacional Tech
      <button id="backButton">Voltar</button>
    </div>

    <div id="chatWindow" class="chat-wrap"></div>

    <button id="restartButton">Reiniciar</button>

    <div class="input-area">
      <input id="chatInput" placeholder="Digite sua resposta..." />
      <button id="sendButton">Enviar</button>
    </div>

    <script>
      const API_KEY = "AIzaSyBkia7YPWbkNzcZIFIYNxKC8NM9Jr5YPCQ";

      // Modelo que funciona (o seu antigo)
      const API_URL =
        "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=" +
        API_KEY;

      let historico = [];
      let contadorPerguntas = 0;
      const LIMITE = 5;

      const chatWindow = document.getElementById("chatWindow");
      const chatInput = document.getElementById("chatInput");
      const sendButton = document.getElementById("sendButton");

      /* ---------------------------- BUBBLES ---------------------------- */
      function addAgentBubble(text) {
        const wrap = document.createElement("div");
        wrap.className = "flex flex-col self-start";

        const bubble = document.createElement("div");
        bubble.className = "agent-bubble";
        bubble.textContent = text;

        wrap.appendChild(bubble);
        chatWindow.appendChild(wrap);
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }

      function addUserBubble(text) {
        const bubble = document.createElement("div");
        bubble.className = "user-bubble";
        bubble.textContent = text;

        chatWindow.appendChild(bubble);
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }

      /* ---------------------------- GEMINI REQUEST ---------------------------- */
      async function enviarParaGemini(prompt) {
        const body = {
          contents: [
            {
              parts: [{ text: prompt }],
            },
          ],
        };

        const resposta = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify(body),
        });

        const dados = await resposta.json();

        try {
          return dados.candidates[0].content.parts[0].text.trim();
        } catch {
          return "";
        }
      }

      /* ---------------------------- INICIAR AGENTE ---------------------------- */
      async function iniciarFluxo() {
        const arquivo = await fetch("career_agent.json");
        const json = await arquivo.json();

        historico = [];
        contadorPerguntas = 0;
        chatWindow.innerHTML = "";

        const perguntaInicial = json.agent.initial_question_examples[0];

        addAgentBubble(perguntaInicial);

        historico.push("AGENTE: " + perguntaInicial);

        // ðŸ”¥ foco automÃ¡tico
        chatInput.focus();
      }

      /* ---------------------------- ENVIAR MENSAGEM ---------------------------- */
      async function enviarMensagem() {
        const texto = chatInput.value.trim();
        if (!texto) return;

        addUserBubble(texto);
        historico.push("USUARIO: " + texto);

        chatInput.value = "";
        contadorPerguntas++;

        if (contadorPerguntas < LIMITE) {
          gerarProximaPergunta();
        } else {
          gerarResultadoFinal();
        }
      }

      sendButton.onclick = enviarMensagem;
      chatInput.onkeydown = (e) => {
        if (e.key === "Enter") enviarMensagem();
      };

      /* ---------------------------- PRÃ“XIMA PERGUNTA ---------------------------- */
      async function gerarProximaPergunta() {
        const prompt = `
VocÃª Ã© um orientador vocacional tech.
HistÃ³rico:
${historico.join("\n")}

Gere a prÃ³xima pergunta curta, no formato:
{"pergunta":"texto"}
`;

        const resposta = await enviarParaGemini(prompt);
        const json = extrairJSON(resposta);

        if (json?.pergunta) {
          addAgentBubble(json.pergunta);
          historico.push("AGENTE: " + json.pergunta);
        } else {
          addAgentBubble("NÃ£o entendi, poderia repetir?");
        }
      }

      /* ---------------------------- FINAL ---------------------------- */
      async function gerarResultadoFinal() {
        const prompt = `
Com base no histÃ³rico, gere o resultado final:

{
 "principal": "id-da-carreira",
 "motivo_principal": "motivo curto"
}

Apenas JSON.
`;

        const resposta = await enviarParaGemini(prompt);
        const json = extrairJSON(resposta);

        if (json?.principal) {
          localStorage.setItem("career_result_id", json.principal);
          window.location.href = "careers_dashboard.html";
        } else {
          addAgentBubble("NÃ£o consegui identificar uma carreira final.");
        }
      }

      /* ---------------------------- JSON CLEAN ---------------------------- */
      function extrairJSON(txt) {
        try {
          const i = txt.indexOf("{");
          const f = txt.lastIndexOf("}");
          return JSON.parse(txt.substring(i, f + 1));
        } catch {
          return null;
        }
      }

      /* ---------------------------- BOTÃ•ES ---------------------------- */
      document.getElementById("restartButton").onclick = iniciarFluxo;

      document.getElementById("backButton").onclick = () => {
        window.location.href =
          "https://laurapigosso.github.io/Deploy-Proxima-Parada/";
      };

      /* ---------------------------- INICIAR ---------------------------- */
      iniciarFluxo();
    </script>
  </body>
</html>
